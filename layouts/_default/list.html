{{ define "main" }}
<!-- Archivio (migrazione fedele da archivio.php) -->

<!-- Mini-hero Archivio -->
<header class="archive-hero" aria-label="Archivio contenuti">
  <div class="container">
    <h1 class="page-title">Archivio</h1>
    {{- $count := 0 -}}
    {{- with site.Data.archive.items -}}
      {{- $count = len . -}}
    {{- end -}}
    <p class="filter-note" role="status">
      Cerca tra video e contenuti. Totale risultati:
      <strong aria-live="polite">{{ $count }}</strong>
    </p>
  </div>
</header>

<!-- Barra ricerca -->
<section class="archive-search" aria-label="Ricerca Archivio">
  <div class="container">
    <form id="archive-search-form" class="archive-search__form" method="get" action="{{ .RelPermalink }}">
      <input
        id="q"
        name="q"
        class="archive-search__input"
        type="search"
        placeholder="Cerca per titolo, descrizione, tag"
        aria-label="Cerca"
        value=""
        inputmode="search"
      >
      <label for="kind" class="sr-only">Tipo</label>
      <select id="kind" name="kind" class="archive-search__select" aria-label="Tipo contenuto">
        <option value="">Tutti</option>
        <option value="content">Contenuti</option>
        <option value="video">Video</option>
      </select>
      <button class="archive-search__btn" type="submit" aria-label="Cerca">
        <img src="{{ "icons/search.svg" | absURL }}" class="icon icon--search" alt="" aria-hidden="true" width="18" height="18" decoding="async" loading="eager">
      </button>
      <button class="archive-search__filter-toggle" type="button" aria-label="Filtri" aria-controls="kind" aria-expanded="false">
        <img src="{{ "icons/filter.svg" | absURL }}" class="icon icon--filter" alt="" aria-hidden="true" width="18" height="18" decoding="async" loading="eager">
      </button>
      <button class="archive-search__reset" type="button" aria-label="Svuota ricerca">
        <img src="{{ "icons/reset.svg" | absURL }}" class="icon icon--reset" alt="" aria-hidden="true" width="18" height="18" decoding="async" loading="eager">
      </button>
    </form>
  </div>
</section>

<!-- Elenco archivio - Task 3.3: ARIA live region for dynamic results -->
<section class="archive" aria-label="Risultati" role="region" aria-live="polite">
  <div class="container">

    <!-- SSR: pre-render first page to avoid CLS; JS will hydrate/replace as needed -->
    <ol class="archive-timeline">
      {{- $items := slice -}}
      {{- with site.Data.archive.items -}}
        {{- range $k, $v := . -}}
          {{- $items = $items | append (dict "id" ($v.id | default $k) "kind" ($v.kind | default "content") "date" ($v.date | default "1970-01-01") "title" $v.title "overline" ($v.overline | default "") "desc" ($v.desc | default "") "thumb" ($v.thumb | default "") "links" ($v.links | default (slice)) ) -}}
        {{- end -}}
      {{- end -}}
      {{- $sorted := sort $items "date" "desc" -}}
      {{- $pageSize := 12 -}}
      {{- $pageSlice := first $pageSize $sorted -}}
      {{- $total := len $pageSlice -}}
      {{- range $i, $it := $pageSlice -}}
        {{- $kind := (lower ($it.kind | default "content")) -}}
        {{- $itemNumber := sub $total $i -}}
        {{- $thumb := cond (ne ($it.thumb | default "") "") $it.thumb "images/cards/fblthp_placeholder.webp" -}}
        {{- $primary := "" -}}
        {{- with $it.links -}}
          {{- range . -}}
            {{- if and (eq $primary "") (.href) -}}
              {{- if or (in (lower (print (.btn_class | default "") " " (.class | default ""))) "primary") (eq $primary "") -}}
                {{- $primary = .href -}}
              {{- end -}}
            {{- end -}}
          {{- end -}}
        {{- end -}}
        <li class="archive-item is-{{ $kind }}" style="--item-number: {{ $itemNumber }}" data-item-number="{{ $itemNumber }}">
          <article class="item" data-item-id="{{ $it.id }}" data-kind="{{ $kind }}">
            <div class="item-media">
              {{- if $primary -}}
                <a class="item-thumb" href="{{ $primary }}" target="_blank" rel="noopener" aria-label="Apri: {{ $it.title }}">
                  <img src="{{ $thumb | absURL }}" alt="{{ $it.title }}" width="720" height="1280" loading="lazy" decoding="async">
                </a>
              {{- else -}}
                <figure class="item-thumb">
                  <img src="{{ $thumb | absURL }}" alt="{{ $it.title }}" width="720" height="1280" loading="lazy" decoding="async">
                </figure>
              {{- end -}}
            </div>
            <div class="item-content">
              <div class="item-header">
                <div class="item-overline">
                  {{- with $it.overline -}}{{ . }}{{- end -}}
                  <span class="item-badge">{{ if eq $kind "video" }}Video{{ else }}Contenuto{{ end }}</span>
                </div>
                <h2 class="item-title">{{ $it.title }}</h2>
              </div>
              {{- with $it.desc -}}<p class="item-desc-preview">{{ . }}</p>{{- end -}}
            </div>
          </article>
        </li>
      {{- end -}}
    </ol>

    <!-- Pager (pilotato dal JS) -->
    <nav class="archive-pager" aria-label="Paginazione risultati" role="navigation">
      <a href="#" class="disabled" aria-disabled="true" aria-label="Pagina precedente" rel="prev">« Prec</a>
      <span class="curr" aria-current="page">Pag. 1 / 1</span>
      <a href="#" class="disabled" aria-disabled="true" aria-label="Pagina successiva" rel="next">Succ »</a>
    </nav>

  </div>
</section>

<!-- Backdrop (necessario al bottom-sheet mobile) -->
<div class="archive-sheet-backdrop" aria-hidden="true"></div>

<!-- Bottom-sheet globale (mobile) — Opzione B -->
<aside
  class="archive-sheet"
  role="dialog"
  aria-modal="true"
  aria-hidden="true"
  aria-labelledby="archive-sheet-title"
  tabindex="-1"
>
  <div class="archive-sheet__handle" aria-hidden="true"></div>
  <button class="archive-sheet__close" type="button" aria-label="Chiudi">X</button>
  <h3 id="archive-sheet-title" class="archive-sheet__title"></h3>
  <div class="archive-sheet__content"></div>
  <div class="archive-sheet__ctas" role="group" aria-label="Collegamenti"></div>
</aside>

{{ end }}

